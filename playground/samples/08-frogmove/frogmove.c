#include <conio.h>

void moveLeft(unsigned int addr);
void moveRight(unsigned int addr);
void printTimer(void);

unsigned char copyright[] = "rax@sofia2021";

unsigned char board[] =
{
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 2, 126, 126, 32, 32, 32, 126, 126, 126, 126, 126, 32, 32, 32, 126, 126, 126,
  126, 126, 32, 32, 32, 126, 126, 126, 126, 126, 32, 32, 32, 126, 126, 126, 126,
  126, 32, 32, 32, 126, 126, 2, 126, 126, 32, 32, 32, 126, 126, 126, 126, 126, 32,
  32, 32, 126, 126, 126, 126, 126, 32, 32, 32, 126, 126, 126, 126, 126, 32, 32,
  32, 126, 126, 126, 126, 126, 32, 32, 32, 126, 126, 5, 20, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 3, 20, 32, 64, 64, 64, 64,
  64, 64, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 32, 32, 32, 32, 64, 64, 64,
  64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 32, 32, 32, 3, 20, 32, 64, 64, 64, 64,
  64, 64, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 32, 32, 32, 32, 64, 64, 64,
  64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 32, 32, 32, 5, 20, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 5, 20, 32, 32, 32, 64, 64,
  64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 64, 32,
  32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 32, 5, 20, 32, 32, 32, 64, 64,
  64, 64, 64, 64, 64, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 64, 32,
  32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 32, 5, 20, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 3, 20, 32, 100, 98, 100, 98,
  100, 98, 32, 32, 32, 32, 32, 32, 100, 98, 100, 98, 100, 98, 32, 32, 32, 32, 32,
  32, 32, 32, 100, 98, 100, 98, 100, 98, 32, 32, 32, 32, 32, 3, 20, 32, 113, 112,
  113, 112, 113, 112, 32, 32, 32, 32, 32, 32, 113, 112, 113, 112, 113, 112, 32,
  32, 32, 32, 32, 32, 32, 32, 113, 112, 113, 112, 113, 112, 32, 32, 32, 32, 32, 5,
  20, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 5,
  126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126,
  126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126,
  126, 126, 126, 126, 126, 126, 126, 5, 126, 126, 126, 126, 126, 126, 126, 126,
  126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126,
  126, 126, 42, 47, 92, 47, 126, 126, 126, 126, 126, 126, 126, 126, 126, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 3,
  32, 32, 47, 91, 91, 93, 91, 93, 32, 32, 32, 32, 32, 32, 32, 32, 47, 91, 91, 93,
  91, 93, 32, 32, 32, 32, 32, 32, 47, 91, 91, 93, 91, 93, 32, 32, 32, 32, 32, 3,
  32, 32, 92, 91, 91, 93, 91, 93, 32, 32, 32, 32, 32, 32, 32, 32, 92, 91, 91, 93,
  91, 93, 32, 32, 32, 32, 32, 32, 92, 91, 91, 93, 91, 93, 32, 32, 32, 32, 32, 7,
  45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32,
  45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 6,
  32, 32, 91, 93, 93, 92, 32, 32, 32, 32, 32, 32, 91, 93, 93, 92, 32, 32, 32, 32,
  32, 32, 91, 93, 93, 92, 32, 32, 32, 32, 32, 32, 91, 93, 93, 92, 32, 32, 32, 6,
  32, 32, 91, 93, 93, 47, 32, 32, 32, 32, 32, 32, 91, 93, 93, 47, 32, 32, 32, 32,
  32, 32, 91, 93, 93, 47, 32, 32, 32, 32, 32, 32, 91, 93, 93, 47, 32, 32, 32, 7,
  45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32,
  45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 32, 45, 45, 32, 3,
  47, 91, 91, 93, 32, 32, 32, 32, 32, 47, 91, 91, 93, 91, 93, 32, 32, 32, 32, 32,
  32, 32, 47, 91, 91, 93, 32, 32, 32, 32, 47, 91, 91, 93, 32, 32, 32, 32, 32, 3,
  92, 91, 91, 93, 32, 32, 32, 32, 32, 92, 91, 91, 93, 91, 93, 32, 32, 32, 32, 32,
  32, 32, 92, 91, 91, 93, 32, 32, 32, 32, 92, 91, 91, 93, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 2, 126,
  126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126,
  126, 126, 126, 126, 56, 56, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126,
  126, 126, 126, 126, 126, 126, 2, 126, 126, 126, 126, 126, 126, 126, 126, 126,
  126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 47, 92, 126, 126,
  126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
};

static void* xmemcpy(void* dest, const void* src, unsigned int count)
{
  char* d;
  const char* s;
  for(d = dest, s = src; count; d++, s++, --count)
    *d = *s;
  return dest;
}

typedef void (*voidfnptr)(void);
static voidfnptr sei_ = (voidfnptr)0x0400;

static char moved[] = "Moved!\n";
static char running;

int main(void)
{
  poke(0x0400,0x78);
  poke(0x0401,0x60);
  sei_();

  poke(0x0307,0xff);
  poke(0x0306,0xff);

  xmemcpy((void*)0xbb80, board, sizeof(board));

  running = 1;
  while(running)
  {
    #ifndef RUN_FOREVER
    ++running;
    #endif

    moveLeft(0xbb82 + 4 * 40);
    moveLeft(0xbb82 + 10 * 40);
    moveLeft(0xbb82 + 16 * 40);
    moveLeft(0xbb82 + 22 * 40);

    moveRight(0xbb80 + 39 + 7 * 40);
    moveRight(0xbb80 + 39 + 19 * 40);

    printTimer();
  }

  _puts(moved);

  return 0;
}

static unsigned char hex[] = "FEDCBA9876543210";
void printTimer(void)
{
  unsigned char valhi, vallo;

  vallo = peek(0x0304);
  valhi = peek(0x0305);

  poke(0xbba7-0, hex[vallo&0x0f]);
  vallo >>= 4;
  poke(0xbba7-1, hex[vallo&0x0f]);
  poke(0xbba7-2, hex[valhi&0x0f]);
  valhi >>= 4;
  poke(0xbba7-3, hex[valhi&0x0f]);

  poke(0x0305,0xff);
  poke(0x0304,0xff);
}

void moveLeft(unsigned int addr)
{
  unsigned int addr2 = addr + 40;
  unsigned char i;
  unsigned char char1 = peek(addr);
  unsigned char char2 = peek(addr2);
  for(i = 1; i < 37; ++i)
  {
    poke(addr, peek(addr + 1));
    poke(addr2, peek(addr2 + 1));
    ++addr;
    ++addr2;
  }
  poke(addr, char1);
  poke(addr2, char2);
}

void moveRight(unsigned int addr)
{
  unsigned int addr2 = addr + 40;
  unsigned char i;
  unsigned char char1 = peek(addr);
  unsigned char char2 = peek(addr2);
  for(i = 1; i < 37; ++i)
  {
    poke(addr, peek(addr - 1));
    poke(addr2, peek(addr2 - 1));
    --addr;
    --addr2;
  }
  poke(addr, char1);
  poke(addr2, char2);
}
